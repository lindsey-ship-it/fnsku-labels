<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <title>FNSKU Labels – Vector (no greys) + Auto-download</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js" defer></script>
  <script src="https://cdn.jsdelivr.net/npm/jsbarcode@3.11.6/dist/JsBarcode.all.min.js" defer></script>
  <style>
    /* offscreen SVG host for JsBarcode (we'll read its <rect>s and draw in PDF) */
    #bcsvg { position:absolute; left:-9999px; top:-9999px; width:0; height:0; }
  </style>
</head>
<body>
  <svg id="bcsvg"></svg>

  <script>
  window.addEventListener('load', () => {
    // ---------- Page & grid ----------
    const A4     = { w: 210, h: 297 };     // mm
    const LABEL  = { w: 47.8, h: 28.2 };   // mm
    const COLS = 4, ROWS = 10;

    // gutters: keep total height < 297 mm
    const H_GAP = 2.0;   // mm
    const V_GAP = 1.0;   // mm
    const totalW = COLS * LABEL.w + (COLS - 1) * H_GAP;
    const totalH = ROWS * LABEL.h + (ROWS - 1) * V_GAP;
    const MARGIN_X = (A4.w - totalW) / 2;
    const MARGIN_Y = (A4.h - totalH) / 2;

    // ---------- In-label layout ----------
    const PAD = 2.8;            // mm quiet zones left/right
    const BARCODE_H = 12.5;     // mm bar height

    const FNSKU_FONT = 7;       // pt
    const GAP_AFTER_BARS  = 0.8;  // mm bars → FNSKU
    const GAP_AFTER_FNSKU = 4.5;  // mm FNSKU → text stack

    const SKU_FONT  = 6.2;      // pt (bold)
    const BODY_FONT = 6.0;      // pt (desc)
    const LINE_GAP  = 2.6;      // mm

    const FOOTER_FONT = 6.5;    // pt
    const FOOTER_OFFSET = 2.0;  // mm up from label bottom
    const CLEAR_ABOVE_FOOTER = 3.5; // mm clearance above footer
    const UP_SHIFT = 0.8;       // mm lift for text stack

    // ---------- Query params ----------
    const qp = new URL(location.href).searchParams;
    const getP = (k, d="") => (qp.get(k) ?? d);
    const decode = s => decodeURIComponent(s || "");

    // ---------- Utilities ----------
    function forceDownload(doc, filename){
      try {
        const blob = doc.output("blob");
        const url = URL.createObjectURL(blob);
        const a = document.createElement("a");
        a.href = url;
        a.download = filename;
        document.body.appendChild(a);
        a.click();
        a.remove();
        setTimeout(() => URL.revokeObjectURL(url), 2000);
      } catch (e) {
        doc.save(filename);
      }
    }

    // Draw JsBarcode's SVG bars as vector rects in jsPDF (no raster, no grey)
    function drawBarcodeVectorFromSVG(doc, svgEl, x, y, w, h){
      // JsBarcode sets width/height attributes in px
      const svgw = parseFloat(svgEl.getAttribute('width'))  || 1;
      const svgh = parseFloat(svgEl.getAttribute('height')) || 1;
      const sx = w / svgw;
      const sy = h / svgh;

      const rects = svgEl.querySelectorAll('rect');
      doc.setFillColor(0,0,0);

      rects.forEach(r => {
        // Only draw black bars (skip any white/background rects if present)
        const fill = (r.getAttribute('fill') || 'black').toLowerCase();
        if (fill.includes('white')) return;

        const rx = parseFloat(r.getAttribute('x')) || 0;
        const ry = parseFloat(r.getAttribute('y')) || 0;
        const rw = parseFloat(r.getAttribute('width'))  || 0;
        const rh = parseFloat(r.getAttribute('height')) || 0;

        doc.rect(x + rx * sx, y + ry * sy, rw * sx, rh * sy, 'F');
      });
    }

    function run(){
      const sku     = getP('sku', '');
      const desc    = decode(getP('desc', ''));
      const country = getP('country', '');
      const fnsku   = getP('fnsku', '');

      const { jsPDF } = window.jspdf;
      const doc = new jsPDF({ unit: 'mm', format: 'a4', compress: true });
      doc.setFont('helvetica', 'normal');

      // Build barcode SVG (bars only)
      const bcSVG = document.getElementById('bcsvg');
      bcSVG.innerHTML = '';
      if (fnsku){
        JsBarcode(bcSVG, fnsku, {
          format: 'code128',
          displayValue: false,
          margin: 0,
          width: 1.25,  // ~0.33 mm X-dimension (very scannable)
          height: Math.round(BARCODE_H * 3.78)
        });
      }

      // Draw labels
      for (let r=0; r<ROWS; r++){
        for (let c=0; c<COLS; c++){
          const x0 = MARGIN_X + c * (LABEL.w + H_GAP);
          const y0 = MARGIN_Y + r * (LABEL.h + V_GAP);
          const cx = x0 + LABEL.w/2;
          const maxTextW = LABEL.w - 2*PAD;

          // 1) Bars (vector)
          if (fnsku) {
            const bx = x0 + PAD;
            const by = y0 + PAD;
            const bw = LABEL.w - 2*PAD;
            const bh = BARCODE_H;
            drawBarcodeVectorFromSVG(doc, bcSVG, bx, by, bw, bh);
          }

          // 2) Footer
          const footerY = y0 + LABEL.h - FOOTER_OFFSET;
          doc.setFont('helvetica','normal');
          doc.setFontSize(FOOTER_FONT);
          doc.text('NEW', x0 + PAD, footerY);
          if (country) doc.text(country.toUpperCase(), x0 + LABEL.w - PAD, footerY, { align: 'right' });

          // 3) FNSKU text
          if (fnsku) {
            doc.setFont('helvetica','normal');
            doc.setFontSize(FNSKU_FONT);
            const fnskuY = y0 + PAD + BARCODE_H + GAP_AFTER_BARS;
            doc.text(fnsku, cx, fnskuY, { align: 'center', baseline: 'top' });
          }

          // 4) SKU (bold) + Description (centered)
          const parts = (desc || '').split(',');
          const desc1 = parts[0] ? parts[0].trim() : '';
          const desc2 = parts[1] ? parts[1].trim() : '';

          let startY = y0 + PAD + BARCODE_H + GAP_AFTER_BARS + GAP_AFTER_FNSKU - UP_SHIFT;

          const stackCount = [sku ? 1 : 0, desc1 ? 1 : 0, desc2 ? 1 : 0].reduce((a,b)=>a+b,0);
          const needed = (stackCount>1) ? ((stackCount-1)*LINE_GAP) : 0;
          const maxTopY = footerY - CLEAR_ABOVE_FOOTER - needed;
          if (startY > maxTopY) startY = Math.max(y0 + PAD + BARCODE_H + 0.8, maxTopY);

          let ty = startY;

          if (sku) {
            doc.setFont('helvetica','bold');
            doc.setFontSize(SKU_FONT);
            while (doc.getTextWidth(sku) > maxTextW && doc.getFontSize() > 5.4) {
              doc.setFontSize(doc.getFontSize() - 0.2);
            }
            doc.text(sku, cx, ty, { align: 'center', baseline: 'top' });
            ty += LINE_GAP;
          }

          doc.setFont('helvetica','normal');
          doc.setFontSize(BODY_FONT);
          if (desc1) {
            doc.text(desc1, cx, ty, { align: 'center', baseline: 'top' });
            ty += LINE_GAP;
          }
          if (desc2) {
            doc.text(desc2, cx, ty, { align: 'center', baseline: 'top' });
          }

          // // Debug:
          // doc.setLineWidth(0.15); doc.rect(x0, y0, LABEL.w, LABEL.h);
        }
      }

      const filename = `${(getP('sku','labels') || 'labels')}.pdf`;
      forceDownload(doc, filename);
    }

    run();
  });
  </script>
</body>
</html>
