<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <title>FNSKU Labels â€“ 40 per A4</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/jsbarcode@3.11.6/dist/JsBarcode.all.min.js"></script>
</head>
<body>
  <!-- barcode canvas (bars only, no text) -->
  <canvas id="barcode" width="2400" height="600" style="display:none"></canvas>

  <script>
    const A4 = { w: 210, h: 297 }; 
    const LABEL = { w: 47.8, h: 28.2 }; 
    const COLS = 4;
    const ROWS = 10;

    const MARGIN_X = (A4.w - COLS * LABEL.w) / 2;
    const MARGIN_Y = (A4.h - ROWS * LABEL.h) / 2;

    const PAD = 1.5;      
    const BARCODE_H = 11; 
    const FONT = "helvetica";

    // spacing
    const GAP_AFTER_BARS = 2.5;  // gap before FNSKU text
    const GAP_AFTER_FNSKU = 3;   // gap before description
    const LINE_GAP = 3.2;        // between desc lines & SKU

    const getParam = (k, d="") => {
      const v = new URL(location.href).searchParams.get(k);
      return (v===null||v==="") ? d : v;
    };

    async function run(){
      const sku     = getParam("sku");
      const desc    = decodeURIComponent(getParam("desc"));
      const country = getParam("country");
      const fnsku   = getParam("fnsku");

      const { jsPDF } = window.jspdf;
      const doc = new jsPDF({ unit:"mm", format:"a4", compress:true });
      doc.setFont(FONT,"normal");

      // barcode bars only
      const bc = document.getElementById("barcode");
      let barcodeImg = null;
      if (fnsku){
        JsBarcode(bc, fnsku, {
          format: "code128",
          displayValue: false, // no text here
          margin: 0,
          width: 1.2,
          height: Math.round(BARCODE_H * 3.78)
        });
        barcodeImg = bc.toDataURL("image/png");
      }

      for (let r=0;r<ROWS;r++){
        for (let c=0;c<COLS;c++){
          const x0 = MARGIN_X + c*LABEL.w;
          const y0 = MARGIN_Y + r*LABEL.h;
          const cx = x0 + LABEL.w/2;

          // --- barcode bars ---
          if (barcodeImg){
            const bw = LABEL.w - 2*PAD;
            doc.addImage(barcodeImg,"PNG",x0+PAD,y0+PAD,bw,BARCODE_H);
          }

          // --- FNSKU text (vector, sharp, with extra gap) ---
          if (fnsku){
            doc.setFontSize(10); // bigger, sharper
            const fnskuY = y0 + PAD + BARCODE_H + GAP_AFTER_BARS;
            doc.text(fnsku, cx, fnskuY, { align:"center", baseline:"top" });
          }

          // --- description + SKU ---
          let ty = y0 + PAD + BARCODE_H + GAP_AFTER_BARS + GAP_AFTER_FNSKU;
          doc.setFontSize(6.2);

          const parts = (desc || "").split(",");
          if (parts[0]) {
            doc.text(parts[0].trim(), cx, ty, { align:"center" });
            ty += LINE_GAP;
          }
          if (parts[1]) {
            doc.text(parts[1].trim(), cx, ty, { align:"center" });
            ty += LINE_GAP;
          }
          if (sku) {
            doc.text(sku, cx, ty, { align:"center" });
          }

          // --- footer NEW + Country ---
          doc.setFontSize(6.5);
          doc.text("NEW", x0+PAD, y0+LABEL.h - 2);
          if (country) {
            doc.text(country.toUpperCase(), x0+LABEL.w - PAD, y0+LABEL.h - 2, { align:"right" });
          }
        }
      }

      doc.save(`${sku||"labels"}.pdf`);
    }
    run();
  </script>
</body>
</html>
